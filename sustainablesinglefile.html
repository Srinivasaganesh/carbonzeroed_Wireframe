<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SustainIQ - Unified Intelligence Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #06402B 0%, #0a5d35 100%);
            height: 100vh;
            overflow: hidden;
        }

        .dashboard-container {
            display: flex;
            height: 100vh;
            background: #ffffff;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
        }

        /* Sidebar Styling */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #06402B 0%, #0a5d35 50%, #0f7a40 100%);
            color: white;
            padding: 0;
            position: relative;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="0.5" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="50" r="0.3" fill="rgba(255,255,255,0.05)"/><circle cx="50" cy="90" r="0.4" fill="rgba(255,255,255,0.08)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
            pointer-events: none;
        }

        .logo-section {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 22px;
            font-weight: 700;
            color: #ffffff;
            text-decoration: none;
            cursor: pointer;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #0f7a40, #06402B);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(6, 64, 43, 0.3);
        }

        .nav-section {
            padding: 20px 0;
            position: relative;
            z-index: 1;
        }

        .nav-header {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 20px 15px;
            margin-top: 20px;
        }

        .nav-header:first-child {
            margin-top: 0;
        }

        .nav-item {
            margin: 4px 12px;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #d1fae5;
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            transform: translateX(4px);
        }

        .nav-link:hover::before {
            transform: scaleY(1);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-link.active::before {
            transform: scaleY(1);
        }

        .nav-text {
            font-size: 16px;
            font-weight: 500;
        }

        .nav-icon {
            width: 20px;
            margin-right: 12px;
            text-align: center;
        }

        .sub-nav {
            margin-left: 20px;
            margin-top: 8px;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sub-nav-item {
            margin: 2px 0;
        }

        .sub-nav-link {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .sub-nav-link:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
        }

        .sub-nav-link.active {
            color: #d1fae5;
            background: rgba(209, 250, 229, 0.1);
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            background: #ffffff;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #ffffff;
            padding: 20px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .header-title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            background: linear-gradient(135deg, #06402B, #0f7a40);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border-radius: 50px;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }

        .content-area {
            flex: 1;
            background: linear-gradient(135deg, #06402B 0%, #0a5d35 100%);
            overflow-y: auto;
            position: relative;
        }

        /* All Interface Sections */
        .interface-section {
            padding: 30px;
            min-height: 100%;
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .interface-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100%;
            text-align: center;
            padding: 60px 30px;
        }

        .welcome-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            color: #06402B;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(209, 250, 229, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .welcome-title {
            font-size: 36px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 16px;
        }

        .welcome-subtitle {
            font-size: 18px;
            color: #d1fae5;
            max-width: 600px;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        /* Feature Cards Grid */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 40px;
            max-width: 1000px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .feature-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .feature-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 24px;
            color: white;
        }

        .feature-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 10px;
        }

        .feature-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.4;
        }

        /* Card Styling */
        .interface-card {
            background: #ffffff;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin: 0 auto;
            max-width: 1200px;
        }

        .interface-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .interface-title {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .interface-description {
            font-size: 16px;
            color: #6b7280;
            line-height: 1.5;
        }

        /* Webhook Configuration */
        .webhook-config {
            background: rgba(6, 64, 43, 0.05);
            border: 1px solid rgba(6, 64, 43, 0.2);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .webhook-config h3 {
            color: #06402B;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .webhook-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            font-family: 'Monaco', 'Menlo', monospace;
            transition: all 0.3s ease;
            background: #ffffff;
        }

        .webhook-input:focus {
            outline: none;
            border-color: #06402B;
            box-shadow: 0 0 0 4px rgba(6, 64, 43, 0.1);
        }

        /* File Drop Zone */
        .file-drop-zone {
            border: 3px dashed #d1d5db;
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .file-drop-zone::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(6, 64, 43, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .file-drop-zone:hover {
            border-color: #06402B;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .file-drop-zone:hover::before {
            opacity: 1;
        }

        .file-drop-zone.dragover {
            border-color: #0a5d35;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            transform: scale(1.02);
        }

        .drop-icon {
            font-size: 64px;
            color: #9ca3af;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .file-drop-zone:hover .drop-icon {
            color: #06402B;
            transform: scale(1.1);
        }

        .drop-text {
            font-size: 20px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .drop-subtext {
            font-size: 14px;
            color: #6b7280;
        }

        .file-input {
            display: none;
        }

        /* Progress Section */
        .progress-section {
            margin-top: 30px;
            display: none;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #e5e7eb;
            z-index: 1;
        }

        .progress-step.completed::after {
            background: #06402B;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .step-circle.active {
            background: #06402B;
            color: white;
            animation: pulse 2s infinite;
        }

        .step-circle.completed {
            background: #06402B;
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
        }

        .step-circle.active + .step-label,
        .step-circle.completed + .step-label {
            color: #06402B;
            font-weight: 600;
        }

        /* API Status Display */
        .api-status {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            display: none;
        }

        .api-status h4 {
            margin-bottom: 15px;
            color: #1f2937;
            font-size: 16px;
        }

        .api-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #e5e7eb;
        }

        .api-item.loading {
            border-left-color: #fbbf24;
        }

        .api-item.success {
            border-left-color: #06402B;
        }

        .api-item.error {
            border-left-color: #ef4444;
        }

        .api-name {
            font-weight: 500;
            color: #1f2937;
        }

        .api-status-text {
            font-size: 14px;
            color: #6b7280;
        }

        .api-status-text.loading {
            color: #fbbf24;
        }

        .api-status-text.success {
            color: #06402B;
        }

        .api-status-text.error {
            color: #ef4444;
        }

        /* Files Preview */
        .files-preview {
            margin-top: 30px;
            display: none;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .file-item {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .file-item:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .file-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #06402B, #0a5d35);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-right: 16px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .file-details {
            font-size: 14px;
            color: #6b7280;
        }

        /* Categories Section */
        .categories-section {
            display: none;
            margin-top: 30px;
        }

        .categories-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .categories-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .categories-description {
            font-size: 16px;
            color: #6b7280;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .category-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 25px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #06402B, #0a5d35);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .category-card:hover {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
        }

        .category-card:hover::before {
            transform: scaleX(1);
        }

        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .category-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 16px;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        }

        .category-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .category-textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
            line-height: 1.5;
        }

        .category-textarea:focus {
            outline: none;
            border-color: #06402B;
            box-shadow: 0 0 0 4px rgba(6, 64, 43, 0.1);
        }

        .category-textarea::placeholder {
            color: #9ca3af;
        }

        /* Submit Section */
        .submit-section {
            display: none;
            margin-top: 30px;
            text-align: center;
        }

        .submit-button {
            background: linear-gradient(135deg, #06402B 0%, #0a5d35 100%);
            color: white;
            border: none;
            padding: 18px 48px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 8px 25px rgba(6, 64, 43, 0.3);
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(6, 64, 43, 0.4);
        }

        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Forms and Controls */
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .form-col {
            flex: 1;
            min-width: 250px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: #ffffff;
        }

        .form-input:focus {
            outline: none;
            border-color: #06402B;
            box-shadow: 0 0 0 3px rgba(6, 64, 43, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .form-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #06402B 0%, #0a5d35 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(6, 64, 43, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6, 64, 43, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #ffffff;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #f9fafb;
            transform: translateY(-1px);
        }

        .btn.loading {
            position: relative;
            pointer-events: none;
            opacity: .85;
        }

        .btn.loading:after {
            content: '';
            position: absolute;
            right: 10px;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.7);
            border-top-color: rgba(255,255,255,0.1);
            border-radius: 50%;
            animation: spin .7s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status Messages */
        .status-message {
            margin-top: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .status-success {
            background: rgba(6, 64, 43, 0.1);
            border: 1px solid rgba(6, 64, 43, 0.3);
            color: #06402B;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #991b1b;
        }

        .status-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #1e40af;
        }

        /* HTML Actions Section */
        .html-actions-section {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #bbf7d0;
            border-radius: 16px;
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .html-actions-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .html-actions-title {
            color: #06402B;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .html-actions-subtitle {
            color: #059669;
            font-size: 14px;
        }

        .html-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .html-action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .html-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .html-action-btn.preview {
            color: #3b82f6;
            border: 1px solid #93c5fd;
        }

        .html-action-btn.open {
            color: #06402B;
            border: 1px solid #bbf7d0;
        }

        .html-action-btn.download {
            color: #059669;
            border: 1px solid #a7f3d0;
        }

        .html-action-btn.copy {
            color: #8b5cf6;
            border: 1px solid #c4b5fd;
        }

        /* Tables */
        .table-container {
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            display: none;
        }

        .table-container.active {
            display: block;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .data-table th {
            background: linear-gradient(135deg, #06402B, #0a5d35);
            color: white;
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 0.875rem 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
            color: #374151;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .cell-ellipsis {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .editable {
            cursor: pointer;
            background-color: #f9fafb;
        }

        .editable:hover {
            background-color: rgba(6, 64, 43, 0.05);
        }

        .saving {
            opacity: 0.6;
            font-style: italic;
        }

        /* Pagination */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .pagination-info {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .pagination-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .pagination-buttons button {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            background: #ffffff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .pagination-buttons button:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #06402B;
        }

        .pagination-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-indicator {
            padding: 0.5rem 0.75rem;
            color: #6b7280;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .page-size-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.875rem;
        }

        /* Loading States */
        .loading-container {
            display: none;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            text-align: center;
        }

        .loading-container.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-left-color: #06402B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .loading-text {
            color: #6b7280;
            font-weight: 500;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #06402B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        /* API Response Display */
        .response-section {
            margin-top: 30px;
            display: none;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 5px;
        }

        .response-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }

        .response-controls {
            display: flex;
            gap: 10px;
        }

        .control-button {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: #f9fafb;
            border-color: #06402B;
        }

        .response-container {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }

        .response-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 16px 16px 0 0;
        }

        .response-tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #6b7280;
        }

        .response-tab:first-child {
            border-radius: 16px 0 0 0;
        }

        .response-tab.active {
            color: #06402B;
            border-bottom-color: #06402B;
            background: #ffffff;
        }

        .response-content {
            padding: 25px;
        }

        .response-panel {
            display: none;
        }

        .response-panel.active {
            display: block;
        }

        .response-raw {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        .response-formatted {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .response-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .meta-value {
            font-size: 14px;
            color: #1f2937;
            font-weight: 500;
        }

        /* Controls Section */
        .controls-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .connection-status {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .status-label {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.875rem;
        }

        .status-text {
            color: #6b7280;
            font-size: 0.875rem;
        }

        /* Placeholder Content */
        .placeholder-content {
            padding: 60px 40px;
            text-align: center;
            color: #ffffff;
            font-size: 18px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
            
            .categories-grid {
                grid-template-columns: 1fr;
            }
            
            .interface-section {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-col {
                min-width: auto;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }
            
            .nav-text {
                display: none;
            }
            
            .sub-nav {
                display: none;
            }
            
            .interface-section {
                padding: 15px;
            }
            
            .interface-card {
                padding: 30px 20px;
            }
            
            .welcome-screen {
                padding: 40px 20px;
            }

            .progress-steps {
                flex-direction: column;
                gap: 20px;
            }

            .progress-step::after {
                display: none;
            }

            .html-actions {
                flex-direction: column;
            }

            .html-action-btn {
                width: 100%;
            }

            .controls-section {
                flex-direction: column;
                align-items: stretch;
            }

            .pagination-controls {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-section">
                <div class="logo" onclick="showInterface('welcome')">
                    <div class="logo-icon">🌱</div>
                    <span>SustainIQ</span>
                </div>
            </div>

            <nav class="nav-section">
                <div class="nav-header">Data Intelligence</div>
                
                <!-- Data Extraction -->
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="extraction">
                        <i class="nav-icon fas fa-upload"></i>
                        <span class="nav-text">Data Extraction</span>
                    </a>
                    <div class="sub-nav">
                        <div class="sub-nav-item">
                            <a href="#" class="sub-nav-link" data-subsection="advanced-processing">Advanced Processing</a>
                        </div>
                        <div class="sub-nav-item">
                            <a href="#" class="sub-nav-link" data-subsection="custom-agent">Custom Agent</a>
                        </div>
                    </div>
                </div>

                <div class="nav-header">Data Management</div>
                
                <!-- Data Verification -->
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="verification">
                        <i class="nav-icon fas fa-check-circle"></i>
                        <span class="nav-text">Data Verification</span>
                    </a>
                </div>

                <div class="nav-header">Analysis Modules</div>

                <!-- Emission Analysis -->
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="emission">
                        <i class="nav-icon fas fa-chart-line"></i>
                        <span class="nav-text">Emission Analysis</span>
                    </a>
                    <div class="sub-nav">
                        <div class="sub-nav-item">
                            <a href="#" class="sub-nav-link" data-subsection="dataset-choice">Dataset Choice</a>
                        </div>
                        <div class="sub-nav-item">
                            <a href="#" class="sub-nav-link" data-subsection="emission-calculation">Emission Calculation</a>
                        </div>
                    </div>
                </div>

                <div class="nav-header">Reporting</div>

                <!-- Report Generation -->
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="reporting">
                        <i class="nav-icon fas fa-file-alt"></i>
                        <span class="nav-text">Sustainability Reporting</span>
                    </a>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <h1 class="header-title">Sustainability Intelligence Platform</h1>
                <div class="header-actions">
                    <div class="status-badge">
                        <div class="status-dot"></div>
                        <span>System Online</span>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Welcome Screen -->
                <div id="welcome-screen" class="interface-section active">
                    <div class="welcome-screen">
                        <div class="welcome-icon">🌱</div>
                        <h1 class="welcome-title">Welcome to SustainIQ</h1>
                        <p class="welcome-subtitle">
                            Your comprehensive sustainability intelligence platform with advanced data extraction, 
                            verification, emission analysis, and automated reporting capabilities.
                        </p>
                        
                        <div class="features-grid">
                            <div class="feature-card" onclick="showInterface('advanced-processing')">
                                <div class="feature-icon">📊</div>
                                <div class="feature-title">Advanced Processing</div>
                                <div class="feature-description">Smart sequential processing with intelligent HTML rendering</div>
                            </div>
                            <div class="feature-card" onclick="showInterface('custom-agent')">
                                <div class="feature-icon">🤖</div>
                                <div class="feature-title">Custom Agent</div>
                                <div class="feature-description">Create AI agents for automated data extraction</div>
                            </div>
                            <div class="feature-card" onclick="showInterface('verification')">
                                <div class="feature-icon">✅</div>
                                <div class="feature-title">Data Verification</div>
                                <div class="feature-description">Verify and validate sustainability data</div>
                            </div>
                            <div class="feature-card" onclick="showInterface('dataset-choice')">
                                <div class="feature-icon">📈</div>
                                <div class="feature-title">Emission Analysis</div>
                                <div class="feature-description">Calculate and analyze carbon emissions</div>
                            </div>
                            <div class="feature-card" onclick="showInterface('reporting')">
                                <div class="feature-icon">📄</div>
                                <div class="feature-title">Sustainability Reports</div>
                                <div class="feature-description">Generate comprehensive sustainability reports</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Processing Interface -->
                <div id="advanced-processing-interface" class="interface-section">
                    <div class="interface-card">
                        <div class="interface-header">
                            <h2 class="interface-title">Advanced Processing Pipeline</h2>
                            <p class="interface-description">Smart sequential processing with intelligent HTML rendering and multiple fallback systems</p>
                        </div>

                        <!-- Progress Tracker -->
                        <div class="progress-section" id="progressSection">
                            <div class="progress-steps">
                                <div class="progress-step" id="step1">
                                    <div class="step-circle">1</div>
                                    <div class="step-label">File Upload</div>
                                </div>
                                <div class="progress-step" id="step2">
                                    <div class="step-circle">2</div>
                                    <div class="step-label">Parallel Processing</div>
                                </div>
                                <div class="progress-step" id="step3">
                                    <div class="step-circle">3</div>
                                    <div class="step-label">Smart Extraction</div>
                                </div>
                            </div>

                            <!-- API Status Display -->
                            <div class="api-status" id="apiStatus">
                                <h4>API Processing Status</h4>
                                <div class="api-item" id="webhook1">
                                    <span class="api-name">Processing Agent 1 (Energy_Utilities)</span>
                                    <span class="api-status-text">Waiting...</span>
                                </div>
                                <div class="api-item" id="webhook2">
                                    <span class="api-name">Processing Agent 2 (water_land)</span>
                                    <span class="api-status-text">Waiting...</span>
                                </div>
                                <div class="api-item" id="webhook3">
                                    <span class="api-name">Processing Agent 3 (Fuels_and_Combustion)</span>
                                    <span class="api-status-text">Waiting...</span>
                                </div>
                                <div class="api-item" id="webhook4">
                                    <span class="api-name">Processing Agent 4 (Mobility)</span>
                                    <span class="api-status-text">Waiting...</span>
                                </div>
                                <div class="api-item" id="webhook5">
                                    <span class="api-name">Processing Agent 5 (Procurement_and_waste)</span>
                                    <span class="api-status-text">Waiting...</span>
                                </div>
                                <div class="api-item" id="extraction">
                                    <span class="api-name">Smart Extraction API</span>
                                    <span class="api-status-text">Waiting for all webhooks...</span>
                                </div>
                            </div>
                        </div>

                        <form id="advancedUploadForm">
                            <div class="file-drop-zone" id="advancedDropZone">
                                <input type="file" id="advancedFileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt,.jpg,.png">
                                <div class="drop-icon">📄</div>
                                <div class="drop-text">Drop files here or click to browse</div>
                                <div class="drop-subtext">Supports PDF, Word, Excel, CSV, and image files</div>
                            </div>

                            <div id="advancedFilesPreview" class="files-preview">
                                <h3 style="font-size: 20px; font-weight: 600; color: #1f2937; margin-bottom: 20px;">Selected Files</h3>
                                <div id="advancedFilesGrid" class="files-grid"></div>
                                <div id="advancedFilenames" style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                                    <h4 style="color: #06402B; margin-bottom: 10px;">Filenames for extraction (sent only if all webhooks succeed):</h4>
                                    <div id="advancedFilenamesList" style="font-family: monospace; color: #374151;"></div>
                                </div>
                            </div>

                            <div id="advancedCategoriesSection" class="categories-section">
                                <div class="categories-header">
                                    <h3 class="categories-title">Sustainability Categories</h3>
                                    <p class="categories-description">Optional: Provide additional context for each sustainability category</p>
                                </div>

                                <div class="categories-grid">
                                    <div class="category-card">
                                        <div class="category-header">
                                            <div class="category-icon" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">⚡</div>
                                            <div class="category-title">Energy & Utilities</div>
                                        </div>
                                        <textarea class="category-textarea" name="energy_utilities" placeholder="Describe energy consumption, utility usage, power generation, renewable energy initiatives..."></textarea>
                                    </div>

                                    <div class="category-card">
                                        <div class="category-header">
                                            <div class="category-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">💧</div>
                                            <div class="category-title">Water & Land Use</div>
                                        </div>
                                        <textarea class="category-textarea" name="water_land" placeholder="Document water consumption, land usage, irrigation, conservation efforts..."></textarea>
                                    </div>

                                    <div class="category-card">
                                        <div class="category-header">
                                            <div class="category-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">🔥</div>
                                            <div class="category-title">Fuels & Combustion</div>
                                        </div>
                                        <textarea class="category-textarea" name="fuels_combustion" placeholder="Report fuel usage, combustion processes, emissions, heating systems..."></textarea>
                                    </div>

                                    <div class="category-card">
                                        <div class="category-header">
                                            <div class="category-icon" style="background: linear-gradient(135deg, #06402B, #0a5d35);">🚗</div>
                                            <div class="category-title">Mobility</div>
                                        </div>
                                        <textarea class="category-textarea" name="mobility" placeholder="Detail transportation, vehicle usage, travel patterns, logistics..."></textarea>
                                    </div>

                                    <div class="category-card">
                                        <div class="category-header">
                                            <div class="category-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">♻️</div>
                                            <div class="category-title">Procurement, Waste & Maintenance</div>
                                        </div>
                                        <textarea class="category-textarea" name="procurement_waste" placeholder="Describe procurement processes, waste management, maintenance activities..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <div id="advancedSubmitSection" class="submit-section">
                                <button type="submit" class="submit-button" id="advancedSubmitButton">
                                    Start Advanced Processing
                                </button>
                            </div>
                        </form>

                        <div id="advancedStatusMessage" class="status-message"></div>

                        <!-- Persistent HTML Actions Section -->
                        <div id="advancedHtmlActionsSection" class="html-actions-section">
                            <div class="html-actions-header">
                                <div class="html-actions-title">HTML Report Ready</div>
                                <div class="html-actions-subtitle">Choose how you want to view or save your results</div>
                            </div>
                            <div id="advancedHtmlActions" class="html-actions">
                                <!-- Buttons will be added here -->
                            </div>
                        </div>

                        <!-- API Response Display -->
                        <div id="advancedResponseSection" class="response-section">
                            <div class="response-header">
                                <h3 class="response-title">Processing Results</h3>
                                <div class="response-controls">
                                    <button class="control-button" onclick="copyAdvancedResponse()">Copy</button>
                                    <button class="control-button" onclick="clearAdvancedResponse()">Clear</button>
                                </div>
                            </div>
                            <div class="response-container">
                                <div class="response-tabs">
                                    <div class="response-tab active" onclick="switchAdvancedTab(event, 'advanced-formatted')">Results</div>
                                    <div class="response-tab" onclick="switchAdvancedTab(event, 'advanced-raw')">Raw Data</div>
                                </div>
                                <div class="response-content">
                                    <div id="advanced-formatted" class="response-panel active">
                                        <div id="advancedResponseFormatted" class="response-formatted">
                                            No results yet. Start processing to see results here.
                                        </div>
                                    </div>
                                    <div id="advanced-raw" class="response-panel">
                                        <div id="advancedResponseRaw" class="response-raw">
                                            No results yet. Start processing to see raw data here.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custom Agent Interface -->
                <div id="custom-agent-interface" class="interface-section">
                    <div class="interface-card">
                        <div class="interface-header">
                            <h2 class="interface-title">Custom Agent Wizard</h2>
                            <p class="interface-description">Create and deploy custom AI agents for automated data extraction workflows</p>
                        </div>
                        
                        <!-- Agent Configuration -->
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Agent Name</label>
                                    <input type="text" id="agentName" class="form-input" placeholder="e.g., Packaging Waste Extractor">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Webhook Path</label>
                                    <input type="text" id="agentPath" class="form-input" placeholder="custom-agents/packaging-waste">
                                    <div class="form-hint">Auto-generated from agent name</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Target Database Table</label>
                                    <input type="text" id="dbTable" class="form-input" placeholder="sustainability_records" value="sustainability_records">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">n8n Base URL</label>
                                    <input type="text" id="n8nBaseUrl" class="form-input" value="http://localhost:5678">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">n8n API Key</label>
                                    <input type="text" id="n8nApiKey" class="form-input" placeholder="Your n8n API key" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMmUwN2QxNy04NDJkLTQyZWEtYjQxYS00NDA5NDcxOGJiNWMiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzU3NTg0NTMzfQ.YSM83QVKL_9c7sdIMTdla_u5PscKf-2zuGttNL6IXsI">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Insert into Database?</label>
                                    <select id="insertToggle" class="form-input form-select">
                                        <option value="yes" selected>Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- MIME Types -->
                        <div class="form-group">
                            <label class="form-label">Accepted MIME Types</label>
                            <input type="text" id="mimeTypes" class="form-input" value="application/pdf,text/csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel">
                            <div class="form-hint">Comma-separated list of MIME types the agent should accept</div>
                        </div>

                        <!-- Document Tool Prompt -->
                        <div class="form-group">
                            <label class="form-label">Document Tool Prompt</label>
                            <textarea id="documentPrompt" class="form-input form-textarea" placeholder="Enter the instructions for the document tool here...">Extract sustainability data including carbon emissions, energy consumption, waste generation, and travel data from the provided document. Focus on numerical values, dates, locations, and categorical information needed for environmental impact calculations.</textarea>
                            <div class="form-hint">Define what data the agent should extract from documents</div>
                        </div>

                        <!-- Credentials Section -->
                        <div class="webhook-config">
                            <h3>AI Service Credentials</h3>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label">Google Gemini Credentials (ID | Name)</label>
                                        <input type="text" id="geminiCreds" class="form-input" value="KIq58RKFRUPil9Kz | Google Gemini(PaLM) Api account">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label">Azure OpenAI Credentials (ID | Name)</label>
                                        <input type="text" id="azureCreds" class="form-input" value="oY1NeqDGxOWYRSi1 | Azure Open AI account">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Collapsible Sections -->
                        <details open>
                            <summary style="cursor: pointer; font-weight: 600; padding: 0.75rem 0; color: #374151; border-bottom: 1px solid #e5e7eb; margin-bottom: 1rem;">Output JSON Schema</summary>
                            <div class="form-group">
                                <textarea id="jsonSchema" class="form-input" style="font-family: 'Monaco', 'Menlo', monospace; min-height: 200px;">{ 
  "items": [
    {
      "category": null,
      "date": null,
      "service_type": null,
      "fuel_type": null,
      "material": null,
      "waste_type": null,
      "recharge_type": null,
      "origin": null,
      "destination": null,
      "class_of_travel": null,
      "no_of_passengers": null,
      "trip_mode": null,
      "vehicle_model": null,
      "vehicle_make": null,
      "site": null,
      "account_type": null,
      "consumption": null,
      "unit": null,
      "amount_spent": null,
      "scope": null,
      "file_name": null
    }
  ]
}</textarea>
                            </div>
                        </details>

                        <details>
                            <summary style="cursor: pointer; font-weight: 600; padding: 0.75rem 0; color: #374151; border-bottom: 1px solid #e5e7eb; margin-bottom: 1rem;">System & User Defaults</summary>
                            <div class="form-group">
                                <label class="form-label">System Message</label>
                                <textarea id="systemMessage" class="form-input form-textarea">You are a sustainability data extraction agent.
Always return valid JSON only, no markdown, no commentary.
Follow your agent-specific instructions strictly.
Do not extract data outside your agent's assigned categories.
Ignore all unrelated data even if similar fields exist elsewhere.
If no relevant information is found, return: { "items": [] }</textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">User Message Template</label>
                                <textarea id="userMessage" class="form-input form-textarea">You are a carbon-data extraction agent. Your sole task is to extract fields that are potentially required to calculate a carbon footprint from any document.
Do not normalize values. Return exactly as found.
Be layout-robust (merged cells, multiple pages/sheets, rotated headers, multilingual).</textarea>
                            </div>
                        </details>

                        <!-- Action Buttons -->
                        <div class="form-row" style="margin-top: 2rem;">
                            <button type="button" class="btn btn-primary" id="createAgentBtn" onclick="createCustomAgent()">
                                <i class="fas fa-magic"></i>
                                Create & Activate Workflow
                            </button>
                            <button type="button" class="btn btn-secondary" id="previewJsonBtn" onclick="previewWorkflowJson()">
                                <i class="fas fa-eye"></i>
                                Preview Workflow JSON
                            </button>
                        </div>

                        <!-- Results -->
                        <div id="agentResults" style="margin-top: 2rem;"></div>
                    </div>
                </div>

                <!-- Data Verification Interface -->
                <div id="verification-interface" class="interface-section">
                    <div class="interface-card">
                        <div class="interface-header">
                            <h2 class="interface-title">Data Verification</h2>
                            <p class="interface-description">Verify and validate sustainability data for accuracy and compliance</p>
                        </div>
                        
                        <!-- Controls -->
                        <div class="controls-section">
                            <div class="connection-status">
                                <div class="status-label">Database Connection Status</div>
                                <div class="status-text" id="connectionStatus">Ready to connect to database</div>
                            </div>
                            <div class="form-row" style="margin: 0; flex: 1; max-width: 600px;">
                                <div class="form-col">
                                    <input type="text" id="webhookUrl" class="form-input" placeholder="Enter n8n webhook URL" value="http://localhost:5678/webhook/data-verification">
                                </div>
                                <button type="button" class="btn btn-primary" id="loadDataBtn" onclick="loadVerificationData()">
                                    <i class="fas fa-database"></i>
                                    Load Database Records
                                </button>
                            </div>
                        </div>

                        <!-- Loading -->
                        <div id="loadingContainer" class="loading-container">
                            <div>
                                <div class="spinner"></div>
                                <div class="loading-text">Loading database records...</div>
                            </div>
                        </div>

                        <!-- Table -->
                        <div id="dataTableContainer" class="table-container">
                            <div class="table-wrapper">
                                <table id="dataTable" class="data-table">
                                    <thead id="tableHeader"></thead>
                                    <tbody id="tableBody"></tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <div class="pagination-controls">
                                <div class="pagination-info">
                                    <span id="recordsInfo">Showing 0 of 0 records</span>
                                </div>
                                <div class="pagination-buttons">
                                    <button onclick="goToFirstPage()" id="firstPageBtn">
                                        <i class="fas fa-angle-double-left"></i>
                                    </button>
                                    <button onclick="goToPreviousPage()" id="prevPageBtn">
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                    <span id="pageIndicator" class="page-indicator">1 / 1</span>
                                    <button onclick="goToNextPage()" id="nextPageBtn">
                                        <i class="fas fa-angle-right"></i>
                                    </button>
                                    <button onclick="goToLastPage()" id="lastPageBtn">
                                        <i class="fas fa-angle-double-right"></i>
                                    </button>
                                </div>
                                <div class="page-size-controls">
                                    <label for="pageSizeSelect">Rows per page:</label>
                                    <select id="pageSizeSelect" class="form-input form-select" onchange="changePageSize(this.value)" style="width: auto; min-width: 80px;">
                                        <option value="10">10</option>
                                        <option value="25" selected>25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dataset Choice Interface -->
                <div id="dataset-choice-interface" class="interface-section">
                    <div class="interface-card">
                        <div class="interface-header">
                            <h2 class="interface-title">Emission Factor Dataset Upload</h2>
                            <p class="interface-description">Upload an emission factor dataset to begin the analysis and calculation process.</p>
                        </div>

                        <!-- Step 1: Upload Dataset -->
                        <div class="webhook-config">
                            <h3>Dataset Upload Webhook</h3>
                            <input type="text" class="webhook-input" id="datasetWebhookUrl" placeholder="Enter your dataset upload webhook URL here..." />
                        </div>

                        <form id="datasetUploadForm">
                            <div class="file-drop-zone" id="datasetDropZone">
                                <input type="file" id="datasetFileInput" class="file-input" accept=".csv,.xls,.xlsx">
                                <div class="drop-icon">📊</div>
                                <div class="drop-text">Drop your dataset file here or click to browse</div>
                                <div class="drop-subtext">Supports CSV, XLS, and XLSX files</div>
                            </div>

                            <div id="datasetFilesPreview" class="files-preview">
                                <h3 style="font-size: 20px; font-weight: 600; color: #1f2937; margin-bottom: 20px;">Selected Dataset</h3>
                                <div id="datasetFilesGrid" class="files-grid"></div>
                            </div>

                            <div id="datasetSubmitSection" class="submit-section">
                                <button type="submit" class="submit-button" id="datasetSubmitButton">Upload Dataset</button>
                            </div>
                        </form>

                        <div id="datasetStatusMessage" class="status-message"></div>

                        <div id="datasetResponseSection" class="response-section">
                            <div class="response-header">
                                <h3 class="response-title">Dataset Upload Response</h3>
                                <div class="response-controls">
                                    <button class="control-button" onclick="copyResponse('dataset')">Copy</button>
                                    <button class="control-button" onclick="clearResponse('datasetResponseSection')">Clear</button>
                                </div>
                            </div>
                            <div class="response-container">
                                <div class="response-tabs">
                                    <div class="response-tab active" data-type="dataset" onclick="switchTab(event, 'dataset-formatted')">Formatted</div>
                                    <div class="response-tab" data-type="dataset" onclick="switchTab(event, 'dataset-raw')">Raw JSON</div>
                                    <div class="response-tab" data-type="dataset" onclick="switchTab(event, 'dataset-meta')">Metadata</div>
                                </div>
                                <div class="response-content">
                                    <div id="dataset-formatted" class="response-panel active">
                                        <div id="datasetResponseFormatted" class="response-formatted">Waiting for dataset upload...</div>
                                    </div>
                                    <div id="dataset-raw" class="response-panel">
                                        <pre id="datasetResponseRaw" class="response-raw">Waiting for dataset upload...</pre>
                                    </div>
                                    <div id="dataset-meta" class="response-panel">
                                        <div id="datasetResponseMeta" class="response-meta">
                                            <div class="meta-item"><span class="meta-label">Status</span><span class="meta-value" id="datasetMetaStatus">-</span></div>
                                            <div class="meta-item"><span class="meta-label">Time</span><span class="meta-value" id="datasetMetaTime">-</span></div>
                                            <div class="meta-item"><span class="meta-label">Type</span><span class="meta-value" id="datasetMetaType">-</span></div>
                                            <div class="meta-item"><span class="meta-label">Size</span><span class="meta-value" id="datasetMetaSize">-</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Calculate Emission Factor -->
                        <div id="emissionCalculationSection" style="display: none; margin-top: 40px; border-top: 1px solid #e5e7eb; padding-top: 40px;">
                            <div class="interface-header">
                                <h3 class="categories-title">Emission Factor Calculation</h3>
                                <p class="categories-description">Dataset successfully processed. You can now proceed with the calculation.</p>
                            </div>
                            <div class="submit-section" style="display: block;">
                                <button type="button" class="submit-button" id="calculateEmissionButton">
                                    Calculate Emission Factor
                                </button>
                            </div>

                            <div id="calculationStatusMessage" class="status-message"></div>

                            <div id="calculationResponseSection" class="response-section">
                                <div class="response-header">
                                    <h3 class="response-title">Calculation Response</h3>
                                    <div class="response-controls">
                                        <button class="control-button" onclick="copyResponse('calculation')">Copy</button>
                                        <button class="control-button" onclick="clearResponse('calculationResponseSection')">Clear</button>
                                    </div>
                                </div>
                                <div class="response-container">
                                    <div class="response-tabs">
                                        <div class="response-tab active" data-type="calculation" onclick="switchTab(event, 'calculation-formatted')">Formatted</div>
                                        <div class="response-tab" data-type="calculation" onclick="switchTab(event, 'calculation-raw')">Raw JSON</div>
                                        <div class="response-tab" data-type="calculation" onclick="switchTab(event, 'calculation-meta')">Metadata</div>
                                    </div>
                                    <div class="response-content">
                                        <div id="calculation-formatted" class="response-panel active">
                                            <div id="calculationResponseFormatted" class="response-formatted">Waiting for calculation to be triggered...</div>
                                        </div>
                                        <div id="calculation-raw" class="response-panel">
                                            <pre id="calculationResponseRaw" class="response-raw">Waiting for calculation to be triggered...</pre>
                                        </div>
                                        <div id="calculation-meta" class="response-panel">
                                            <div id="calculationResponseMeta" class="response-meta">
                                                <div class="meta-item"><span class="meta-label">Status</span><span class="meta-value" id="calculationMetaStatus">-</span></div>
                                                <div class="meta-item"><span class="meta-label">Time</span><span class="meta-value" id="calculationMetaTime">-</span></div>
                                                <div class="meta-item"><span class="meta-label">Type</span><span class="meta-value" id="calculationMetaType">-</span></div>
                                                <div class="meta-item"><span class="meta-label">Size</span><span class="meta-value" id="calculationMetaSize">-</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emission Calculation Interface -->
                <div id="emission-calculation-interface" class="interface-section">
                    <div class="interface-card">
                        <div class="interface-header">
                            <h2 class="interface-title">Emission Analysis Prompts</h2>
                            <p class="interface-description">Configure AI prompts for emission analysis and calculations</p>
                        </div>

                        <div class="webhook-config">
                            <h3>Emission Analysis Webhook</h3>
                            <input type="text" class="webhook-input" id="emissionWebhookUrl" 
                                   value="http://localhost:5678/webhook/457366eb-f988-4d3c-a301-9d2f0df8f3a6" 
                                   placeholder="Enter emission analysis webhook URL..." />
                            <small style="color: #6b7280; font-size: 12px; margin-top: 8px; display: block;">
                                Configure webhook endpoint for emission analysis and prompt processing
                            </small>
                        </div>

                        <div style="margin-top: 30px;">
                            <h3 style="font-size: 20px; font-weight: 600; color: #1f2937; margin-bottom: 20px;">Prompt Configuration</h3>
                            
                            <div class="category-card" style="margin-bottom: 20px;">
                                <div class="category-header">
                                    <div class="category-icon" style="background: linear-gradient(135deg, #06402B, #0a5d35);">🌡️</div>
                                    <div class="category-title">Emission Calculation Prompts</div>
                                </div>
                                <textarea class="category-textarea" id="emissionPrompts" placeholder="Configure AI prompts for emission factor calculations, carbon footprint analysis, and GHG reporting..."></textarea>
                            </div>

                            <div class="submit-section" style="display: block; margin-top: 30px;">
                                <button type="button" class="submit-button" onclick="submitEmissionPrompts()">
                                    Update Emission Prompts
                                </button>
                            </div>
                        </div>

                        <div id="emissionStatusMessage" class="status-message"></div>

                        <!-- API Response Display for Emission Prompts -->
                        <div id="emissionResponseSection" class="response-section">
                            <div class="response-header">
                                <h3 class="response-title">Emission Prompts API Response</h3>
                                <div class="response-controls">
                                    <button class="control-button" onclick="copyResponse('emission')">Copy</button>
                                    <button class="control-button" onclick="clearResponse('emissionResponseSection')">Clear</button>
                                </div>
                            </div>
                            <div class="response-container">
                                <div class="response-tabs">
                                    <div class="response-tab active" data-type="emission" onclick="switchTab(event, 'emission-formatted')">Formatted</div>
                                    <div class="response-tab" data-type="emission" onclick="switchTab(event, 'emission-raw')">Raw JSON</div>
                                    <div class="response-tab" data-type="emission" onclick="switchTab(event, 'emission-meta')">Metadata</div>
                                </div>
                                <div class="response-content">
                                    <div id="emission-formatted" class="response-panel active">
                                        <div id="emissionResponseFormatted" class="response-formatted">
                                            No response yet. Submit emission prompts to see the API response here.
                                        </div>
                                    </div>
                                    <div id="emission-raw" class="response-panel">
                                        <pre id="emissionResponseRaw" class="response-raw">
                                            No response yet. Submit emission prompts to see the raw API response here.
                                        </pre>
                                    </div>
                                    <div id="emission-meta" class="response-panel">
                                        <div id="emissionResponseMeta" class="response-meta">
                                            <div class="meta-item">
                                                <span class="meta-label">Status</span>
                                                <span class="meta-value" id="emissionMetaStatus">-</span>
                                            </div>
                                            <div class="meta-item">
                                                <span class="meta-label">Response Time</span>
                                                <span class="meta-value" id="emissionMetaTime">-</span>
                                            </div>
                                            <div class="meta-item">
                                                <span class="meta-label">Content Type</span>
                                                <span class="meta-value" id="emissionMetaType">-</span>
                                            </div>
                                            <div class="meta-item">
                                                <span class="meta-label">Size</span>
                                                <span class="meta-value" id="emissionMetaSize">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sustainability Reporting Interface -->
                <div id="reporting-interface" class="interface-section">
				  <div class="interface-card">
					<div class="interface-header">
					  <h2 class="interface-title">Sustainability Reporting</h2>
					  <p class="interface-description">Generate comprehensive sustainability reports and compliance documentation</p>
					</div>

					<div class="webhook-config">
					  <h3>n8n Webhook URL</h3>
					  <input id="n8nWebhookUrl" class="webhook-input" value="/report/generate" />
					  <div class="form-hint">
						Leave as <code>/report/generate</code> to use the new proxy.  
						(Advanced: set to <code>/webhook/report</code> or a full n8n URL if you need direct access.)
					  </div>
					</div>

					<div class="form-row" style="margin-top: 8px;">
					  <button id="btnGenerateReport" class="btn btn-primary">
						<i class="fas fa-play"></i> Generate Report
					  </button>
					  <button id="btnDownloadReport" class="btn btn-secondary" disabled>
						<i class="fas fa-download"></i> Download
					  </button>
					</div>

					<div id="reportStatus" class="status-message" style="display:none;"></div>

					<div class="interface-card" style="padding:0; margin-top:16px;">
					  <iframe id="reportIframe" style="width:100%; height:700px; border:0; display:none;"></iframe>
					  <div id="reportEmptyState" style="padding:40px; text-align:center; color:#6b7280;">
						<i class="fas fa-file-alt" style="font-size:40px; margin-bottom:12px;"></i>
						<div>Your report will appear here.</div>
					  </div>
					</div>
				  </div>
				</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration and Global State
        const CONFIG = {
            DATA_VERIFICATION_WEBHOOK: 'http://localhost:5678/webhook/data-verification',
            DATA_VERIFICATION_UPDATE_WEBHOOK: 'http://localhost:5678/webhook/data-verification-update',
            AUTH_TOKEN: 'Bearer devtoken123',
            EDITABLE_COLUMNS: {
                destination: { type: 'string', label: 'Destination' },
                class_of_travel: { type: 'string', label: 'Class of Travel' },
                no_of_passengers: { type: 'number', min: 0, integer: true },
                trip_mode: { type: 'string', label: 'Trip Mode' },
                vehicle_model: { type: 'string' },
                vehicle_make: { type: 'string', label: 'Vehicle Make' },
                site: { type: 'string' },
                account_type: { type: 'string' },
                consumption: { type: 'number', min: 0 },
                unit: { type: 'string' },
                amount_spent: { type: 'number', min: 0 },
                scope: { type: 'string' },
                emission_factor: { type: 'number', min: 0 },
                reason: { type: 'string', max: 500 }
            }
        };

        // Hardcoded webhook URLs for advanced processing
        const WEBHOOK_URLS = [
            'http://localhost:5678/webhook/Energy_Utilities',
            'http://localhost:5678/webhook/Water_land_Use',
            'http://localhost:5678/webhook/Fuels_and_Combustion',
            'http://localhost:5678/webhook/Mobility',
            'http://localhost:5678/webhook/Procurement_and_waste'
        ];

        const EXTRACTION_WEBHOOK_URL = 'http://localhost:5678/webhook/extraction';

        // Global state variables
        let currentPage = 1;
        let pageSize = 25;
        let totalRecords = 0;
        let totalPages = 0;
        let allData = [];
        let filteredData = [];
        let extractedDatasetFilename = null;

        // Store responses globally
        let apiResponses = {
            upload: null,
            emission: null,
            report: null,
            dataset: null,
            calculation: null,
            advanced: null
        };

        // Store global processing results and HTML data
        let processingResults = {
            uploadedFilenames: [],
            webhookResponses: [],
            extractionResult: null,
            htmlData: null
        };

        // Utility Functions
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#06402B' : '#ef4444'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text == null ? '' : String(text);
            return div.innerHTML;
        }

        function slugify(text) {
            return text.toLowerCase()
                      .replace(/[^a-z0-9]+/g, '-')
                      .replace(/(^-|-$)/g, '');
        }

        // Navigation Functions
        function showInterface(interfaceName) {
			// Hide all interfaces
			document.querySelectorAll('.interface-section').forEach(section => {
				section.classList.remove('active');
			});

			// Remove active class from all nav links and sub-nav links
			document.querySelectorAll('.nav-link, .sub-nav-link').forEach(link => {
				link.classList.remove('active');
			});

			// Show target interface
			const targetInterface = document.getElementById(`${interfaceName}-interface`) || document.getElementById('welcome-screen');
			targetInterface.classList.add('active');

			// Set appropriate nav link as active
			const navMapping = {
				'welcome': 'welcome',
				'advanced-processing': 'extraction',
				'custom-agent': 'extraction',
				'verification': 'verification',
				'dataset-choice': 'emission',
				'emission-calculation': 'emission',
				'reporting': 'reporting'
			};

			const mainSection = navMapping[interfaceName] || 'welcome';
			const mainNavLink = document.querySelector(`[data-section="${mainSection}"]`);
			if (mainNavLink) mainNavLink.classList.add('active');

			const subNavLink = document.querySelector(`[data-subsection="${interfaceName}"]`);
			if (subNavLink) subNavLink.classList.add('active');
		}

        // Navigation Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Main navigation
            document.querySelectorAll('.nav-link').forEach(link => {
				link.addEventListener('click', function(e) {
					e.preventDefault();
					const section = this.getAttribute('data-section');
					if (section) {
						document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
						this.classList.add('active');
						
						// If it's a main section without subsections, show the interface directly
						if (section === 'verification' || section === 'reporting') {
							showInterface(section);
						}
					}
				});
			});

            // Sub-navigation
            document.querySelectorAll('.sub-nav-link').forEach(link => {
				link.addEventListener('click', function(e) {
					e.preventDefault();
					const subsection = this.getAttribute('data-subsection');
					if (subsection) {
						document.querySelectorAll('.sub-nav-link').forEach(l => l.classList.remove('active'));
						this.classList.add('active');
						showInterface(subsection);
					}
				});
			});

            // Set default active state
			const firstNavLink = document.querySelector('.nav-link[data-section="extraction"]');
			if (firstNavLink) firstNavLink.classList.add('active');
			
			const firstSubNavLink = document.querySelector('.sub-nav-link[data-subsection="advanced-processing"]');
			if (firstSubNavLink) firstSubNavLink.classList.add('active');
			
			showInterface('welcome');
			updateAgentPath();
			showToast('SustainIQ Dashboard loaded successfully');
		});

        // Advanced Processing Functions
        function updateProgressStep(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            if (!step) return;
            
            const circle = step.querySelector('.step-circle');
            circle.classList.remove('active', 'completed');
            
            if (status === 'active') {
                circle.classList.add('active');
            } else if (status === 'completed') {
                circle.classList.add('completed');
                circle.innerHTML = '✓';
            }
            
            // Mark previous steps as completed
            if (status === 'active' || status === 'completed') {
                for (let i = 1; i < stepNumber; i++) {
                    const prevStep = document.getElementById(`step${i}`);
                    if (prevStep) {
                        const prevCircle = prevStep.querySelector('.step-circle');
                        prevCircle.classList.remove('active');
                        prevCircle.classList.add('completed');
                        prevCircle.innerHTML = '✓';
                        prevStep.classList.add('completed');
                    }
                }
            }
        }

        function updateApiStatus(apiId, status, message = '') {
            const apiElement = document.getElementById(apiId);
            if (!apiElement) return;
            
            const statusText = apiElement.querySelector('.api-status-text');
            apiElement.classList.remove('loading', 'success', 'error');
            statusText.classList.remove('loading', 'success', 'error');
            
            apiElement.classList.add(status);
            statusText.classList.add(status);
            
            switch(status) {
                case 'loading':
                    statusText.textContent = 'Processing...';
                    break;
                case 'success':
                    statusText.textContent = message || 'Success';
                    break;
                case 'error':
                    statusText.textContent = message || 'Failed';
                    break;
            }
        }

        // File Handling Functions
        function setupFileDrop(dropZoneId, fileInputId, previewId, gridId, sectionsToShow) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            if (!dropZone || !fileInput) return;

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                fileInput.files = e.dataTransfer.files;
                handleFileSelection(fileInput, previewId, gridId, sectionsToShow);
            });
            fileInput.addEventListener('change', () => handleFileSelection(fileInput, previewId, gridId, sectionsToShow));
        }

        function handleFileSelection(fileInput, previewId, gridId, sectionsToShow) {
            if (fileInput.files.length === 0) return;
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';
            
            if (gridId === 'advancedFilesGrid') {
                processingResults.uploadedFilenames = [];
            }
            
            Array.from(fileInput.files).forEach((file, index) => {
                const fileItem = createFileItem(file, index);
                grid.appendChild(fileItem);
                
                if (gridId === 'advancedFilesGrid') {
                    processingResults.uploadedFilenames.push(file.name);
                }
            });

            // Display filenames for advanced processing
            if (gridId === 'advancedFilesGrid') {
                const filenamesList = document.getElementById('advancedFilenamesList');
                if (filenamesList) {
                    filenamesList.innerHTML = processingResults.uploadedFilenames
                        .map(name => `• ${name}`)
                        .join('<br>');
                }
                updateProgressStep(1, 'completed');
            }

            document.getElementById(previewId).style.display = 'block';
            sectionsToShow.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'block';
            });
        }

        function createFileItem(file, index) {
            const div = document.createElement('div');
            div.className = 'file-item';
            const iconMap = { pdf: '📄', word: '📝', document: '📝', excel: '📊', spreadsheet: '📊', image: '🖼️', csv: '📈' };
            const type = Object.keys(iconMap).find(key => file.type.includes(key)) || 'default';
            const size = (file.size / 1024 / 1024).toFixed(2);
            div.innerHTML = `
                <div class="file-icon">${iconMap[type] || '📄'}</div>
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-details">${size} MB • ${file.type || 'Unknown'}</div>
                </div>
            `;
            return div;
        }

        // Setup file drops
        setupFileDrop('advancedDropZone', 'advancedFileInput', 'advancedFilesPreview', 'advancedFilesGrid', ['advancedCategoriesSection', 'advancedSubmitSection']);
        setupFileDrop('datasetDropZone', 'datasetFileInput', 'datasetFilesPreview', 'datasetFilesGrid', ['datasetSubmitSection']);

        // Advanced Processing API Functions
        async function callApi(url, formData, apiId) {
            try {
                updateApiStatus(apiId, 'loading');
                const response = await fetch(url, { method: 'POST', body: formData });

                let responseData;
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                } else {
                    responseData = await response.text();
                }

                if (response.ok) {
                    updateApiStatus(apiId, 'success', `Completed (${response.status})`);
                    return { success: true, data: responseData, url: url, status: response.status };
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                updateApiStatus(apiId, 'error', `Error: ${error.message}`);
                return { success: false, error: error.message, url: url };
            }
        }

        async function callExtractionApi(filenames, categoryData = {}) {
            try {
                updateApiStatus('extraction', 'loading');
                
                const formData = new FormData();
                formData.append('filenames', JSON.stringify(filenames));
                formData.append('extraction_type', 'advanced_processing');
                
                Object.entries(categoryData).forEach(([key, value]) => {
                    if (value) formData.append(key, value);
                });
                
                const response = await fetch(EXTRACTION_WEBHOOK_URL, { method: 'POST', body: formData });

                let responseData;
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                } else {
                    responseData = await response.text();
                }

                if (response.ok) {
                    updateApiStatus('extraction', 'success', 'Extraction completed');
                    return { success: true, data: responseData, message: 'Extraction completed successfully' };
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                updateApiStatus('extraction', 'error', `Error: ${error.message}`);
                return { success: false, error: error.message, message: 'Extraction failed' };
            }
        }

        // HTML Processing Functions
        function extractHtmlContent(responseData) {
            if (typeof responseData === 'string' && responseData.trim().toLowerCase().includes('<!doctype html>')) {
                return responseData;
            }

            if (typeof responseData === 'object' && responseData !== null) {
                const htmlProperties = ['html', 'content', 'data', 'result', 'output', 'report'];
                for (const prop of htmlProperties) {
                    const potentialHtml = responseData[prop];
                    if (typeof potentialHtml === 'string' && potentialHtml.trim().toLowerCase().includes('<!doctype html>')) {
                        return potentialHtml;
                    }
                }
            }
            return null;
        }

        function openHtmlInNewTab(responseData) {
            try {
                let htmlContent = extractHtmlContent(responseData);
                
                if (!htmlContent) {
                    htmlContent = `
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>Extraction Result</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                                .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                                pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <h1>Extraction Result</h1>
                                <pre>${escapeHtml(typeof responseData === 'string' ? responseData : JSON.stringify(responseData, null, 2))}</pre>
                            </div>
                        </body>
                        </html>
                    `;
                }
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const newTab = window.open(url, '_blank');
                
                if (newTab) {
                    newTab.onload = () => URL.revokeObjectURL(url);
                    showToast('HTML report opened in new tab!');
                    return true;
                } else {
                    throw new Error('Popup blocked or failed to open');
                }
                
            } catch (error) {
                console.error('Primary method failed, using fallback:', error);
                showHtmlInModal(responseData);
                return false;
            }
        }

        function showHtmlInModal(responseData) {
            let htmlContent = extractHtmlContent(responseData);
            if (!htmlContent) {
                htmlContent = `<pre>${escapeHtml(JSON.stringify(responseData, null, 2))}</pre>`;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 10000;
                display: flex; justify-content: center; align-items: center;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; width: 90%; height: 90%; border-radius: 10px;
                overflow: hidden; position: relative;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '× Close';
            closeBtn.style.cssText = `
                position: absolute; top: 10px; right: 10px; z-index: 10001;
                background: #ef4444; color: white; border: none; padding: 10px 15px;
                border-radius: 5px; cursor: pointer;
            `;
            
            const iframe = document.createElement('iframe');
            iframe.style.cssText = 'width: 100%; height: 100%; border: none;';
            iframe.srcdoc = htmlContent;
            
            modalContent.appendChild(closeBtn);
            modalContent.appendChild(iframe);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            const closeModal = () => document.body.removeChild(modal);
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            showToast('HTML report displayed in modal');
        }

        function showHtmlActionButtons(responseData) {
            processingResults.htmlData = responseData;
            
            const htmlActionsSection = document.getElementById('advancedHtmlActionsSection');
            const htmlActionsContainer = document.getElementById('advancedHtmlActions');
            
            htmlActionsContainer.innerHTML = '';
            
            const buttons = [
                { text: '👁️ Preview HTML', class: 'preview', action: () => showHtmlInModal(responseData) },
                { text: '🔗 Open in New Tab', class: 'open', action: () => openHtmlInNewTab(responseData) },
                { text: '💾 Download HTML', class: 'download', action: () => downloadHtml(responseData) },
                { text: '📋 Copy HTML', class: 'copy', action: () => copyHtmlToClipboard(responseData) }
            ];
            
            buttons.forEach(buttonConfig => {
                const button = document.createElement('button');
                button.className = `html-action-btn ${buttonConfig.class}`;
                button.textContent = buttonConfig.text;
                button.addEventListener('click', buttonConfig.action);
                htmlActionsContainer.appendChild(button);
            });
            
            htmlActionsSection.style.display = 'block';
        }

        function hideHtmlActionButtons() {
            const htmlActionsSection = document.getElementById('advancedHtmlActionsSection');
            htmlActionsSection.style.display = 'none';
            processingResults.htmlData = null;
        }

        function downloadHtml(responseData) {
            try {
                let htmlContent = extractHtmlContent(responseData);
                if (!htmlContent) {
                    htmlContent = `
                        <!DOCTYPE html>
                        <html><head><title>Extraction Result</title></head>
                        <body><pre>${escapeHtml(JSON.stringify(responseData, null, 2))}</pre></body></html>
                    `;
                }
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `extraction_result_${new Date().getTime()}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                showToast('HTML file downloaded successfully!');
            } catch (error) {
                showToast('Download failed: ' + error.message, 'error');
            }
        }

        function copyHtmlToClipboard(responseData) {
            try {
                let htmlContent = extractHtmlContent(responseData);
                if (!htmlContent) {
                    htmlContent = JSON.stringify(responseData, null, 2);
                }
                
                navigator.clipboard.writeText(htmlContent).then(() => {
                    showToast('HTML content copied to clipboard!');
                }).catch(() => {
                    showToast('Copy failed - please try manual copy', 'error');
                });
            } catch (error) {
                showToast('Copy failed: ' + error.message, 'error');
            }
        }

        function showAdvancedStatus(message, type) {
            const statusEl = document.getElementById('advancedStatusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            if (type !== 'info' && type !== 'success') {
                setTimeout(() => {
                    if (statusEl.textContent === message) statusEl.style.display = 'none';
                }, 8000);
            } else if (type === 'success' && !processingResults.htmlData) {
                setTimeout(() => {
                    if (statusEl.textContent === message) statusEl.style.display = 'none';
                }, 8000);
            }
        }

        function displayAdvancedResults() {
            const responseSection = document.getElementById('advancedResponseSection');
            const responseFormatted = document.getElementById('advancedResponseFormatted');
            const responseRaw = document.getElementById('advancedResponseRaw');
            
            responseSection.style.display = 'block';
            
            let formattedHtml = '<div style="font-family: inherit;">';
            
            formattedHtml += '<h4 style="color: #06402B; margin-bottom: 15px;">Uploaded Files</h4>';
            formattedHtml += '<div style="margin-bottom: 20px; background: #f0fdf4; padding: 15px; border-radius: 8px;">';
            processingResults.uploadedFilenames.forEach(filename => {
                formattedHtml += `<div style="margin: 5px 0;">📄 ${filename}</div>`;
            });
            formattedHtml += '</div>';
            
            formattedHtml += '<h4 style="color: #06402B; margin-bottom: 15px;">Processing Webhook Results</h4>';
            formattedHtml += '<div style="margin-bottom: 20px;">';
            processingResults.webhookResponses.forEach((result, index) => {
                const status = result.success ? '✅' : '❌';
                const statusColor = result.success ? '#06402B' : '#ef4444';
                formattedHtml += `
                    <div style="margin: 10px 0; padding: 10px; background: #f8fafc; border-radius: 8px; border-left: 4px solid ${statusColor};">
                        <strong>${status} Webhook ${index + 1} (${result.url.split('/').pop()}):</strong> 
                        ${result.success ? `Success (Status: ${result.status})` : `Failed - ${result.error}`}
                    </div>
                `;
            });
            formattedHtml += '</div>';
            
            if (processingResults.extractionResult) {
                formattedHtml += '<h4 style="color: #06402B; margin-bottom: 15px;">Smart Extraction Result</h4>';
                if (processingResults.extractionResult.success) {
                    formattedHtml += '<div style="color: #06402B; font-weight: 600; margin-bottom: 10px;">✅ Extraction Successful</div>';
                    formattedHtml += '<div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 10px 0;">';
                    formattedHtml += '<div style="margin-bottom: 10px; font-weight: 600;">HTML rendering options available above</div>';
                    const data = processingResults.extractionResult.data;
                    const snippet = typeof data === 'string' ? data.substring(0, 500) + (data.length > 500 ? '...' : '') : JSON.stringify(data, null, 2);
                    formattedHtml += `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0; max-height: 200px; overflow-y: auto;">${escapeHtml(snippet)}</pre>`;
                    formattedHtml += '</div>';
                } else {
                    formattedHtml += '<div style="color: #ef4444; font-weight: 600;">❌ Extraction Failed</div>';
                    formattedHtml += `<div style="margin: 10px 0; color: #ef4444;">${processingResults.extractionResult.error || 'Unknown error'}</div>`;
                }
            } else {
                formattedHtml += '<h4 style="color: #ef4444; margin-bottom: 15px;">Smart Extraction Result</h4>';
                formattedHtml += '<div style="color: #ef4444; font-weight: 600;">❌ Extraction not triggered (not all webhooks successful)</div>';
            }
            formattedHtml += '</div>';
            
            responseFormatted.innerHTML = formattedHtml;
            responseRaw.textContent = JSON.stringify(processingResults, null, 2);
        }

        // Advanced Processing Form Handler
        document.getElementById('advancedUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const files = Array.from(document.getElementById('advancedFileInput').files);
            if (files.length === 0) {
                showAdvancedStatus('Please select at least one file!', 'error');
                return;
            }

            const submitButton = document.getElementById('advancedSubmitButton');
            
            try {
                processingResults.webhookResponses = [];
                processingResults.extractionResult = null;
                hideHtmlActionButtons();
                
                submitButton.innerHTML = '<span class="loading-spinner"></span>Processing...';
                submitButton.disabled = true;
                
                document.getElementById('progressSection').style.display = 'block';
                document.getElementById('apiStatus').style.display = 'block';
                
                updateProgressStep(2, 'active');
                showAdvancedStatus('Starting parallel processing of 5 webhooks...', 'info');

                const formData = new FormData();
                
                files.forEach((file, index) => {
                    formData.append(`file_${index}`, file);
                    formData.append(`filename_${index}`, file.name);
                });
                
                const textareas = document.querySelectorAll('#advancedCategoriesSection .category-textarea');
                const categoryData = {};
                textareas.forEach(textarea => {
                    if (textarea.value.trim()) {
                        formData.append(textarea.name, textarea.value.trim());
                        categoryData[textarea.name] = textarea.value.trim();
                    }
                });
                
                formData.append('file_count', files.length.toString());
                formData.append('timestamp', new Date().toISOString());

                const webhookPromises = WEBHOOK_URLS.map((url, index) => 
                    callApi(url, formData, `webhook${index + 1}`)
                );
                
                const webhookResults = await Promise.all(webhookPromises);
                processingResults.webhookResponses = webhookResults;
                
                updateProgressStep(2, 'completed');
                
                const successfulWebhooks = webhookResults.filter(result => result.success).length;
                const totalWebhooks = webhookResults.length;
                
                if (successfulWebhooks === totalWebhooks) {
                    updateProgressStep(3, 'active');
                    showAdvancedStatus(`All ${totalWebhooks} webhooks successful! Starting smart extraction...`, 'info');
                    
                    const extractionResult = await callExtractionApi(processingResults.uploadedFilenames, categoryData);
                    processingResults.extractionResult = extractionResult;
                    
                    updateProgressStep(3, 'completed');
                    
                    if (extractionResult.success) {
                        showAdvancedStatus('Processing completed successfully!', 'success');
                        showHtmlActionButtons(extractionResult.data);
                        openHtmlInNewTab(extractionResult.data);
                    } else {
                        showAdvancedStatus(`All webhooks successful but extraction failed: ${extractionResult.error}`, 'error');
                    }
                } else {
                    showAdvancedStatus(`Only ${successfulWebhooks}/${totalWebhooks} webhooks successful. Extraction not triggered (requires all webhooks to succeed).`, 'error');
                    updateApiStatus('extraction', 'error', 'Skipped (not all webhooks successful)');
                }
                
                displayAdvancedResults();
                
            } catch (error) {
                showAdvancedStatus(`Processing failed: ${error.message}`, 'error');
                console.error('Processing error:', error);
            } finally {
                submitButton.innerHTML = 'Start Advanced Processing';
                submitButton.disabled = false;
            }
        });

        function switchAdvancedTab(event, tabId) {
            const container = event.target.closest('.response-container');
            container.querySelectorAll('.response-tab').forEach(tab => tab.classList.remove('active'));
            container.querySelectorAll('.response-panel').forEach(panel => panel.classList.remove('active'));
            event.target.classList.add('active');
            container.querySelector(`#${tabId}`).classList.add('active');
        }

        function copyAdvancedResponse() {
            const textToCopy = JSON.stringify(processingResults, null, 2);
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast('Results copied to clipboard!');
            });
        }

        function clearAdvancedResponse() {
            document.getElementById('advancedResponseSection').style.display = 'none';
            hideHtmlActionButtons();
            processingResults.webhookResponses = [];
            processingResults.extractionResult = null;
        }

        // Custom Agent Functions
        function updateAgentPath() {
            const name = document.getElementById('agentName').value.trim();
            const pathInput = document.getElementById('agentPath');
            
            if (name && !pathInput.dataset.userModified) {
                pathInput.value = 'custom-agents/' + slugify(name);
            }
        }

        document.getElementById('agentPath').addEventListener('input', function() {
            this.dataset.userModified = 'true';
        });

        document.getElementById('agentName').addEventListener('input', updateAgentPath);

        function parseCredentialPair(credString) {
            const [id, name] = (credString || '').split('|').map(x => x.trim());
            return { id, name };
        }

        function generateNodeId(prefix) {
            return prefix + '-' + Math.random().toString(36).slice(2, 10);
        }

        function generateFanOutCode(mimeTypes) {
            return `
const TARGET_BIN_KEY = 'pdf';
const ACCEPT = new Set('${mimeTypes}'.split(',').map(s=>s.trim()).filter(Boolean));
const out = [];
for (const item of $input.all()) {
  const bin = item.binary || {};
  const baseJson = item.json || {};
  for (const [key,file] of Object.entries(bin)) {
    if (file?.mimeType && ACCEPT.size && !ACCEPT.has(file.mimeType)) continue;
    out.push({ 
      json: { 
        ...baseJson, 
        originalBinaryKey: key, 
        originalFileName: file?.fileName || null, 
        originalMimeType: file?.mimeType || null 
      }, 
      binary: { [TARGET_BIN_KEY]: file } 
    });
  }
}
return out;
            `.trim();
        }

        function generateJsonScrubberCode() {
            return `
// Extract JSON from LLM output
const inputItems = $input.all();
const outputItems = [];
for (const item of inputItems) {
  try {
    let s = item.json.output || item.json.text || item.json.content || JSON.stringify(item.json);
    s = s.replace(/\\\`\\\`\\\`json\\s*\\n?/gi,'').replace(/\\\`\\\`\\\`\\s*$/gi,'').trim();
    const a = s.indexOf('{'); const b = s.lastIndexOf('}');
    if(a!==-1 && b!==-1 && b>a) s = s.substring(a,b+1);
    outputItems.push({ json: JSON.parse(s) });
  } catch (e) {
    outputItems.push({ json: { items: [], _error: 'JSON parse failed: '+e.message } });
  }
}
return outputItems;
            `.trim();
        }

        function generateFinalJsonMapperCode() {
            return `
// AFTER Merge/Agent
const inputs = $input.all();
const rows = [];
const seen = new Set();
function isAllNull(obj){ return Object.values(obj).every(v=>v===null||v===undefined||v===''); }
function pushRecord(rec){
  if(!rec || typeof rec!=='object') return;
  const normalized = Object.assign({}, rec);
  // normalize file_name -> filename
  if('file_name' in normalized && !('filename' in normalized)) normalized.filename = normalized.file_name;
  if(isAllNull(normalized)) return;
  const key = JSON.stringify(normalized);
  if(seen.has(key)) return; seen.add(key);
  rows.push(normalized);
}
for(const it of inputs){
  const j = it.json;
  if(Array.isArray(j?.items)){ for(const r of j.items) pushRecord(r); continue; }
  if(Array.isArray(j)){ for(const group of j){ if(Array.isArray(group?.items)) for(const r of group.items) pushRecord(r); } continue; }
  if(j && typeof j==='object'){ pushRecord(j); }
}
return rows.map(r=>({json:r}));
            `.trim();
        }

        function generateWorkflowJson() {
            const name = document.getElementById('agentName').value.trim();
            const path = document.getElementById('agentPath').value.replace(/^\/+|\/+$/g, '');
            const table = document.getElementById('dbTable').value.trim();
            const insertToDb = document.getElementById('insertToggle').value === 'yes';
            const mimeTypes = document.getElementById('mimeTypes').value;
            const docPrompt = document.getElementById('documentPrompt').value;
            const systemMessage = document.getElementById('systemMessage').value;
            const userMessage = document.getElementById('userMessage').value;
            
            if (!name) throw new Error('Agent name is required');
            if (!docPrompt) throw new Error('Document tool prompt is required');

            let schema;
            try {
                schema = JSON.parse(document.getElementById('jsonSchema').value);
            } catch (e) {
                throw new Error('Invalid JSON schema: ' + e.message);
            }

            const { id: geminiId, name: geminiName } = parseCredentialPair(document.getElementById('geminiCreds').value);
            const { id: azureId, name: azureName } = parseCredentialPair(document.getElementById('azureCreds').value);

            // Generate all node IDs
            const webhookId = generateNodeId('wh');
            const fanOutId = generateNodeId('fan');
            const uploadId = generateNodeId('up');
            const agentId = generateNodeId('agent');
            const azureChatId = generateNodeId('azure');
            const toolId = generateNodeId('tool');
            const jsonId = generateNodeId('json');
            const finalId = generateNodeId('final');
            const insertId = generateNodeId('sql');
            const outputTextId = generateNodeId('txt');
            const codeId = generateNodeId('ok');
            const respondId = generateNodeId('resp');

            const nodes = [
                {
                    id: webhookId,
                    type: "n8n-nodes-base.webhook",
                    typeVersion: 2.1,
                    position: [-2160, 64],
                    name: "Webhook",
                    parameters: {
                        httpMethod: "POST",
                        path: path,
                        responseMode: "responseNode",
                        options: {
                            allowedOrigins: "http://localhost:8080",
                            binaryPropertyName: "data",
                            rawBody: false
                        }
                    }
                },
                {
                    id: fanOutId,
                    type: "n8n-nodes-base.code",
                    typeVersion: 2,
                    position: [-1824, 64],
                    name: "Multiple_Files_Extraction",
                    parameters: {
                        jsCode: generateFanOutCode(mimeTypes)
                    }
                },
                {
                    id: uploadId,
                    type: "@n8n/n8n-nodes-langchain.googleGemini",
                    typeVersion: 1,
                    position: [-1504, 64],
                    name: "Upload a file",
                    parameters: {
                        resource: "file",
                        inputType: "binary",
                        binaryPropertyName: "=pdf"
                    },
                    credentials: {
                        googlePalmApi: {
                            id: geminiId,
                            name: geminiName
                        }
                    }
                },
                {
                    id: agentId,
                    type: "@n8n/n8n-nodes-langchain.agent",
                    typeVersion: 2.1,
                    position: [-1184, 64],
                    name: name,
                    parameters: {
                        promptType: "define",
                        text: `={{ $json.fileUri }}\\n\\n${userMessage}`,
                        options: {
                            systemMessage: systemMessage
                        }
                    }
                },
                {
                    id: azureChatId,
                    type: "@n8n/n8n-nodes-langchain.lmChatAzureOpenAi",
                    typeVersion: 1,
                    position: [-1184, 304],
                    name: "Azure OpenAI Chat Model",
                    parameters: {
                        model: "o4-mini",
                        options: {}
                    },
                    credentials: {
                        azureOpenAiApi: {
                            id: azureId,
                            name: azureName
                        }
                    }
                },
                {
                    id: toolId,
                    type: "@n8n/n8n-nodes-langchain.googleGeminiTool",
                    typeVersion: 1,
                    position: [-1184, 464],
                    name: "Analyze document (tool)",
                    parameters: {
                        resource: "document",
                        modelId: {
                            "__rl": true,
                            "value": "models/gemini-2.5-pro",
                            "mode": "list",
                            "cachedResultName": "models/gemini-2.5-pro"
                        },
                        text: docPrompt,
                        documentUrls: "={{ $json.fileUri }}",
                        options: {}
                    },
                    credentials: {
                        googlePalmApi: {
                            id: geminiId,
                            name: geminiName
                        }
                    }
                },
                {
                    id: jsonId,
                    type: "n8n-nodes-base.code",
                    typeVersion: 2,
                    position: [-768, 64],
                    name: "JSON",
                    parameters: {
                        jsCode: generateJsonScrubberCode()
                    }
                },
                {
                    id: finalId,
                    type: "n8n-nodes-base.code",
                    typeVersion: 2,
                    position: [-432, 64],
                    name: "Final_JSON",
                    parameters: {
                        jsCode: generateFinalJsonMapperCode()
                    }
                },
                {
                    id: outputTextId,
                    type: "n8n-nodes-base.code",
                    typeVersion: 2,
                    position: [-144, -112],
                    name: "Output_Text",
                    parameters: {
                        jsCode: `const items=$input.all().map(i=>i.json);return [{json:{output:JSON.stringify(items,null,2)}}];`
                    }
                },
                {
                    id: codeId,
                    type: "n8n-nodes-base.code",
                    typeVersion: 2,
                    position: [112, -112],
                    name: "Code",
                    parameters: {
                        jsCode: `console.log("success"); return [{ json:{ output: "success" } }];`
                    }
                },
                {
                    id: respondId,
                    type: "n8n-nodes-base.respondToWebhook",
                    typeVersion: 1.4,
                    position: [416, -112],
                    name: "Respond to Webhook",
                    parameters: {
                        respondWith: "text",
                        responseBody: "={{ $json.output }}",
                        options: {
                            responseCode: 200
                        }
                    }
                }
            ];
            
            if (insertToDb) {
                nodes.push({
                    id: insertId,
                    type: "n8n-nodes-base.mySql",
                    typeVersion: 2.5,
                    position: [-64, 272],
                    name: "Insert rows in a table",
                    parameters: {
                        table: table || "sustainability_records",
                        options: {
                            detailedOutput: true
                        }
                    },
                    credentials: {
                        mySql: {
                            id: "1J7io0mDCBiP2OHd",
                            name: "MySQL account"
                        }
                    }
                });
            }

            const connections = {};
            connections[`Webhook`] = { main: [[{ node: "Multiple_Files_Extraction", type: "main", index: 0 }]] };
            connections[`Multiple_Files_Extraction`] = { main: [[{ node: "Upload a file", type: "main", index: 0 }]] };
            connections[`Upload a file`] = { main: [[{ node: name, type: "main", index: 0 }]] };
            connections[`Azure OpenAI Chat Model`] = { ai_languageModel: [[{ node: name, type: "ai_languageModel", index: 0 }]] };
            connections[`Analyze document (tool)`] = { ai_tool: [[{ node: name, type: "ai_tool", index: 0 }]] };
            connections[name] = { main: [[{ node: "JSON", type: "main", index: 0 }]] };
            connections[`JSON`] = { main: [[{ node: "Final_JSON", type: "main", index: 0 }]] };
            
            if (insertToDb) {
                connections[`Final_JSON`] = { main: [[{ node: "Output_Text", type: "main", index: 0 }, { node: "Insert rows in a table", type: "main", index: 0 }]] };
            } else {
                connections[`Final_JSON`] = { main: [[{ node: "Output_Text", type: "main", index: 0 }]] };
            }
            
            connections[`Output_Text`] = { main: [[{ node: "Code", type: "main", index: 0 }]] };
            connections[`Code`] = { main: [[{ node: "Respond to Webhook", type: "main", index: 0 }]] };

            return {
                name: `Custom Agent – ${name}`,
                settings: {},
                nodes,
                connections
            };
        }

        async function createCustomAgent() {
            const btn = document.getElementById('createAgentBtn');
            const results = document.getElementById('agentResults');
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Workflow...';
                
                const workflowData = generateWorkflowJson();
                const apiKey = document.getElementById('n8nApiKey').value.trim();
                
                if (!apiKey) {
                    throw new Error('n8n API key is required');
                }

                const createResponse = await fetch('/api/v1/workflows', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-N8N-API-KEY': apiKey
                    },
                    body: JSON.stringify(workflowData)
                });

                if (!createResponse.ok) {
                    const errorText = await createResponse.text();
                    throw new Error(`Failed to create workflow: ${errorText}`);
                }

                const createResult = await createResponse.json();
                const workflowId = createResult.id || createResult?.data?.id || createResult?.data?.workflow?.id;
                
                if (!workflowId) {
                    throw new Error('Could not determine workflow ID');
                }

                const activateResponse = await fetch(`/api/v1/workflows/${workflowId}/activate`, {
                    method: 'POST',
                    headers: {
                        'X-N8N-API-KEY': apiKey
                    }
                });

                if (!activateResponse.ok) {
                    const errorText = await activateResponse.text();
                    throw new Error(`Failed to activate workflow: ${errorText}`);
                }

                const path = document.getElementById('agentPath').value.replace(/^\/+|\/+$/g, '');
                const baseUrl = document.getElementById('n8nBaseUrl').value.replace(/\/+$/, '');
                const prodUrl = `${baseUrl}/webhook/${path}`;
                const testUrl = `${baseUrl}/webhook-test/${path}`;

                results.innerHTML = `
                    <div style="background: #ffffff; border-radius: 12px; padding: 30px; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h3 style="color: #06402B; font-size: 24px; font-weight: 700; margin-bottom: 10px;">Workflow Created Successfully!</h3>
                            <p style="color: #6b7280;">Your custom agent is now active and ready to process documents.</p>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div>
                                <div style="margin-bottom: 20px;">
                                    <label style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Workflow ID</label>
                                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px; border: 1px solid #e5e7eb;">${workflowId}</div>
                                </div>
                                <div>
                                    <label style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Production Webhook URL</label>
                                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px; border: 1px solid #e5e7eb; word-break: break-all;">${prodUrl}</div>
                                </div>
                            </div>
                            <div>
                                <div style="margin-bottom: 20px;">
                                    <label style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Test Webhook URL</label>
                                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px; border: 1px solid #e5e7eb; word-break: break-all;">${testUrl}</div>
                                </div>
                                <div>
                                    <label style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Test Command</label>
                                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; border: 1px solid #e5e7eb; word-break: break-all;">curl -X POST ${testUrl} \\<br>&nbsp;&nbsp;-H "Authorization: Bearer devtoken123" \\<br>&nbsp;&nbsp;-F "file=@/path/to/your.pdf"</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                showToast('Custom agent workflow created and activated successfully!');

            } catch (error) {
                console.error('Create agent error:', error);
                showToast('Failed to create agent: ' + error.message, 'error');
                results.innerHTML = `
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; padding: 20px;">
                        <div style="color: #dc2626; display: flex; align-items: center;">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 10px;"></i>
                            <strong>Error:</strong> ${error.message}
                        </div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Create & Activate Workflow';
            }
        }

        function previewWorkflowJson() {
            const results = document.getElementById('agentResults');
            
            try {
                const workflowData = generateWorkflowJson();
                results.innerHTML = `
                    <div style="background: #ffffff; border-radius: 12px; padding: 30px; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h3 style="color: #06402B; font-size: 24px; font-weight: 700;">Workflow JSON Preview</h3>
                        </div>
                        <div style="background: #1f2937; color: #f9fafb; border-radius: 8px; padding: 20px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; line-height: 1.5; overflow: auto; max-height: 500px;">
                            ${escapeHtml(JSON.stringify(workflowData, null, 2))}
                        </div>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; padding: 20px;">
                        <div style="color: #dc2626; display: flex; align-items: center;">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 10px;"></i>
                            <strong>Error:</strong> ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // Data Verification Functions
        async function loadVerificationData() {
            const loadBtn = document.getElementById('loadDataBtn');
            const loadingContainer = document.getElementById('loadingContainer');
            const tableContainer = document.getElementById('dataTableContainer');
            const statusEl = document.getElementById('connectionStatus');
            const webhookUrl = document.getElementById('webhookUrl').value || CONFIG.DATA_VERIFICATION_WEBHOOK;

            try {
                loadBtn.disabled = true;
                loadingContainer.classList.add('active');
                tableContainer.classList.remove('active');
                statusEl.textContent = 'Connecting to database...';
                statusEl.style.color = 'var(--primary)';

                const response = await fetch(webhookUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': CONFIG.AUTH_TOKEN
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (Array.isArray(data)) {
                    allData = data;
                } else if (data && Array.isArray(data.data)) {
                    allData = data.data;
                } else if (data && typeof data === 'object') {
                    allData = [data];
                } else {
                    allData = [];
                }

                allData = allData.map(record => ({
                    ...record,
                    updated_at: record.updated_at ?? record.updatedAt ?? null
                }));

                filteredData = [...allData];
                totalRecords = filteredData.length;
                totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
                currentPage = 1;

                renderTable();
                statusEl.textContent = `Connected successfully - ${totalRecords} records found`;
                statusEl.style.color = '#22c55e';
                tableContainer.classList.add('active');
                showToast(`Loaded ${totalRecords} records successfully`);

            } catch (error) {
                console.error('Load error:', error);
                statusEl.textContent = 'Failed to connect to database';
                statusEl.style.color = '#ef4444';
                showToast('Failed to load data: ' + error.message, 'error');
            } finally {
                loadBtn.disabled = false;
                loadingContainer.classList.remove('active');
            }
        }

        function renderTable() {
            const thead = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');
            
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                thead.innerHTML = '<tr><th>No Data Available</th></tr>';
                tbody.innerHTML = '<tr><td style="text-align: center; padding: 2rem; color: #6b7280;">No records available</td></tr>';
                updatePaginationInfo();
                return;
            }

            const columns = Object.keys(filteredData[0]);
            thead.innerHTML = '<tr>' + columns.map(col => 
                `<th>${escapeHtml(col.replace(/_/g, ' ').toUpperCase())}</th>`
            ).join('') + '</tr>';

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, totalRecords);
            const pageItems = filteredData.slice(startIndex, endIndex);

            const rowsHtml = pageItems.map(row => {
                const trAttrs = `data-row-id="${row.id}" data-updated-at="${row.updated_at ?? ''}"`;
                const cells = columns.map(col => {
                    const value = row[col];
                    const isEditable = Object.prototype.hasOwnProperty.call(CONFIG.EDITABLE_COLUMNS, col);
                    const cellClass = isEditable ? 'editable cell-ellipsis' : 'cell-ellipsis';
                    const dataCol = isEditable ? ` data-col="${col}"` : '';
                    const title = value == null ? '' : String(value);
                    
                    return `<td class="${cellClass}"${dataCol} title="${escapeHtml(title)}">${escapeHtml(title)}</td>`;
                }).join('');
                
                return `<tr ${trAttrs}>${cells}</tr>`;
            }).join('');

            tbody.innerHTML = rowsHtml;
            updatePaginationInfo();
            enableInlineEditing();
        }

        function updatePaginationInfo() {
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, totalRecords);
            
            document.getElementById('recordsInfo').textContent = 
                `Showing ${totalRecords > 0 ? startIndex + 1 : 0}-${endIndex} of ${totalRecords} records`;
            document.getElementById('pageIndicator').textContent = `${currentPage} / ${totalPages}`;
            
            document.getElementById('firstPageBtn').disabled = currentPage <= 1;
            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
            document.getElementById('lastPageBtn').disabled = currentPage >= totalPages;
        }

        function changePageSize(newSize) {
            pageSize = parseInt(newSize, 10) || 25;
            totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
            currentPage = 1;
            renderTable();
        }

        function goToFirstPage() {
            currentPage = 1;
            renderTable();
        }

        function goToPreviousPage() {
            currentPage = Math.max(1, currentPage - 1);
            renderTable();
        }

        function goToNextPage() {
            currentPage = Math.min(totalPages, currentPage + 1);
            renderTable();
        }

        function goToLastPage() {
            currentPage = totalPages;
            renderTable();
        }

        function enableInlineEditing() {
            const table = document.getElementById('dataTable');
            if (!table) return;

            table.querySelectorAll('td.editable').forEach(td => {
                td.addEventListener('click', () => {
                    if (td.querySelector('input, textarea')) return;
                    startCellEdit(td);
                });
            });
        }

        function startCellEdit(td) {
            const column = td.dataset.col;
            const rule = CONFIG.EDITABLE_COLUMNS[column];
            if (!rule) return;

            const originalValue = td.textContent.trim();
            const isLongText = rule.type === 'string' && rule.max && rule.max > 120;
            
            const input = isLongText ? document.createElement('textarea') : document.createElement('input');
            
            if (rule.type === 'number') {
                input.type = 'number';
                if (rule.min !== undefined) input.min = rule.min;
                if (rule.integer) input.step = '1';
            }
            
            input.value = originalValue;
            input.dataset.originalValue = originalValue;
            input.style.width = '100%';
            input.style.boxSizing = 'border-box';
            input.style.padding = '0.5rem';
            input.style.border = '2px solid #06402B';
            input.style.borderRadius = '4px';

            td.innerHTML = '';
            td.appendChild(input);
            input.focus();
            input.select();

            const saveEdit = async () => {
                if (input.value !== originalValue) {
                    await saveCellEdit(td, input.value);
                } else {
                    td.textContent = originalValue;
                }
            };

            input.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    await saveEdit();
                } else if (e.key === 'Escape') {
                    td.textContent = originalValue;
                }
            });

            input.addEventListener('blur', saveEdit);
        }

        function coerceAndValidate(rawValue, rule) {
            if (!rule) return { ok: true, value: rawValue };

            if (rule.type === 'number') {
                const num = Number(rawValue);
                if (Number.isNaN(num)) return { ok: false, message: 'Must be a number' };
                if (rule.integer && !Number.isInteger(num)) return { ok: false, message: 'Must be an integer' };
                if (rule.min !== undefined && num < rule.min) return { ok: false, message: `Must be ≥ ${rule.min}` };
                return { ok: true, value: num };
            }

            const str = String(rawValue ?? '').trim();
            if (rule.max && str.length > rule.max) return { ok: false, message: `Max length ${rule.max}` };
            return { ok: true, value: str };
        }

        async function saveCellEdit(td, newRawValue) {
            const tr = td.closest('tr');
            const id = tr?.dataset?.rowId;
            const column = td.dataset.col;
            const rule = CONFIG.EDITABLE_COLUMNS[column];
            const previousValue = (td.querySelector('input, textarea')?.dataset.originalValue ?? '').trim();
            const updatedAt = tr?.dataset?.updatedAt || null;

            const { ok, value, message } = coerceAndValidate(newRawValue, rule);
            
            if (!ok) {
                showToast(message || 'Invalid value', 'error');
                td.textContent = previousValue;
                return;
            }

            if (String(value) === String(previousValue)) {
                td.textContent = previousValue;
                return;
            }

            td.classList.add('saving');
            td.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const webhookUrl = CONFIG.DATA_VERIFICATION_UPDATE_WEBHOOK;
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': CONFIG.AUTH_TOKEN
                    },
                    body: JSON.stringify({
                        id: id,
                        column: column,
                        newValue: value,
                        previousValue: previousValue,
                        updatedAt: updatedAt
                    })
                });

                const result = await response.json().catch(() => ({}));

                if (!response.ok || !result.ok) {
                    throw new Error(result.error || `Update failed (${response.status})`);
                }

                td.textContent = String(value);
                showToast('Changes saved successfully');

                const dataIndex = allData.findIndex(record => String(record.id) === String(id));
                if (dataIndex > -1) {
                    allData[dataIndex][column] = value;
                    filteredData[dataIndex][column] = value;
                }

            } catch (error) {
                console.error('Save error:', error);
                td.textContent = previousValue;
                showToast('Failed to save: ' + error.message, 'error');
            } finally {
                td.classList.remove('saving');
            }
        }

        // Dataset Upload and Emission Calculation Functions
        document.getElementById('datasetUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const webhookUrl = document.getElementById('datasetWebhookUrl').value.trim();
            const file = document.getElementById('datasetFileInput').files[0];
            if (!webhookUrl) return showStatus('Please enter a dataset webhook URL.', 'error', 'datasetStatusMessage');
            if (!file) return showStatus('Please select a dataset file.', 'error', 'datasetStatusMessage');

            const submitButton = document.getElementById('datasetSubmitButton');
            submitButton.innerHTML = '<span class="loading-spinner"></span>Uploading...';
            submitButton.disabled = true;
            showStatus('Uploading dataset...', 'info', 'datasetStatusMessage');
            document.getElementById('emissionCalculationSection').style.display = 'none';
            extractedDatasetFilename = null;
            
            const startTime = Date.now();
            
            const formData = new FormData();
            formData.append('file_0', file);
            formData.append('filename_0', file.name);
            formData.append('file_count', '1');
            formData.append('filenames_json', JSON.stringify([file.name]));

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST', 
                    body: formData
                });
                const responseData = await response.json();
                displayApiResponse(responseData, 'dataset', startTime);

                if (response.ok && responseData.output === 'success' && responseData.filename) {
                    showStatus('Dataset uploaded successfully. Ready for calculation.', 'success', 'datasetStatusMessage');
                    const filenameWithExt = responseData.filename;
                    const lastDotIndex = filenameWithExt.lastIndexOf('.');
                    extractedDatasetFilename = lastDotIndex === -1 ? filenameWithExt : filenameWithExt.substring(0, lastDotIndex);
                    document.getElementById('emissionCalculationSection').style.display = 'block';
                } else {
                    throw new Error(responseData.message || 'Upload was not successful or filename missing in response.');
                }
            } catch (error) {
                displayApiResponse({ success: false, error: error.message }, 'dataset', startTime);
                showStatus(`Upload failed: ${error.message}`, 'error', 'datasetStatusMessage');
            } finally {
                submitButton.innerHTML = 'Upload Dataset';
                submitButton.disabled = false;
            }
        });

        document.getElementById('calculateEmissionButton').addEventListener('click', async function() {
            if (!extractedDatasetFilename) {
                return showStatus('No valid dataset filename available for calculation.', 'error', 'calculationStatusMessage');
            }
            const calculationWebhookUrl = 'http://localhost:5678/webhook/ecalc';
            
            const calcButton = this;
            calcButton.innerHTML = '<span class="loading-spinner"></span>Calculating...';
            calcButton.disabled = true;
            showStatus('Sending request for calculation...', 'info', 'calculationStatusMessage');
            
            const startTime = Date.now();
            
            try {
                const response = await fetch(calculationWebhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: extractedDatasetFilename })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseData = await response.json();
                displayApiResponse(responseData, 'calculation', startTime);
                showStatus('Calculation request completed.', 'success', 'calculationStatusMessage');
            } catch (error) {
                const errorData = { success: false, error: error.message };
                displayApiResponse(errorData, 'calculation', startTime);
                showStatus(`Calculation failed: ${error.message}`, 'error', 'calculationStatusMessage');
            } finally {
                calcButton.innerHTML = 'Calculate Emission Factor';
                calcButton.disabled = false;
            }
        });

        // Generic Status Function
        function showStatus(message, type, elementId) {
            const statusEl = document.getElementById(elementId);
            if (!statusEl) return;
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        // Response Handling Functions
        function switchTab(event, tabId) {
            const container = event.target.closest('.response-container');
            container.querySelectorAll('.response-tab').forEach(tab => tab.classList.remove('active'));
            container.querySelectorAll('.response-panel').forEach(panel => panel.classList.remove('active'));
            event.target.classList.add('active');
            container.querySelector(`#${tabId}`).classList.add('active');
        }

        function copyResponse(responseType) {
            const textToCopy = apiResponses[responseType] ? JSON.stringify(apiResponses[responseType], null, 2) : '';
            if (textToCopy) {
                navigator.clipboard.writeText(textToCopy).then(() => showToast('Response copied to clipboard!'));
            }
        }

        function clearResponse(sectionId) {
            const section = document.getElementById(sectionId);
            section.style.display = 'none';
            
            let type;
            if (sectionId === 'datasetResponseSection') type = 'dataset';
            else if (sectionId === 'calculationResponseSection') type = 'calculation';
            else if (sectionId === 'emissionResponseSection') type = 'emission';

            if (type) {
                apiResponses[type] = null;
                resetResponseDisplay(type);
            }
        }

        function resetResponseDisplay(type) {
            document.getElementById(`${type}ResponseFormatted`).innerHTML = 'No response yet.';
            document.getElementById(`${type}ResponseRaw`).textContent = 'No response yet.';
            document.getElementById(`${type}MetaStatus`).textContent = '-';
            document.getElementById(`${type}MetaTime`).textContent = '-';
            document.getElementById(`${type}MetaType`).textContent = '-';
            document.getElementById(`${type}MetaSize`).textContent = '-';
        }

        function displayApiResponse(responseData, type, startTime) {
            const endTime = Date.now();
            apiResponses[type] = responseData;
            
            document.getElementById(`${type}ResponseSection`).style.display = 'block';
            document.getElementById(`${type}ResponseFormatted`).innerHTML = formatResponse(responseData);
            document.getElementById(`${type}ResponseRaw`).textContent = JSON.stringify(responseData, null, 2);
            document.getElementById(`${type}MetaStatus`).textContent = (responseData.success === true || responseData.output === 'success') ? 'Success' : 'Error';
            document.getElementById(`${type}MetaTime`).textContent = `${endTime - startTime}ms`;
            document.getElementById(`${type}MetaType`).textContent = 'application/json';
            document.getElementById(`${type}MetaSize`).textContent = `${JSON.stringify(responseData).length} bytes`;
        }

        function formatResponse(data) {
            if (!data) return 'No response data';
            let html = '<div style="font-family: inherit;">';
            const isSuccess = data.success === true || data.output === 'success';
            html += `<div style="color: ${isSuccess ? '#059669' : '#dc2626'}; font-weight: 600; margin-bottom: 15px;">${isSuccess ? '✅ Success' : '❌ Error'}</div>`;
            if (data.message) html += `<div style="margin-bottom: 15px;"><strong>Message:</strong> ${data.message}</div>`;
            
            html += '<pre style="white-space: pre-wrap; word-break: break-all; background: #f8fafc; padding: 15px; border-radius: 8px;">' + JSON.stringify(data, null, 2) + '</pre>';

            if (data.error) html += `<div style="color: #dc2626; margin-bottom: 15px; margin-top: 15px;"><strong>Error:</strong> ${data.error}</div>`;
            html += '</div>';
            return html;
        }

        // Emission Prompts Function
        async function submitEmissionPrompts() {
            const webhookUrl = document.getElementById('emissionWebhookUrl').value.trim();
            const prompts = document.getElementById('emissionPrompts').value.trim();
            if (!webhookUrl) return showStatus('Please provide a webhook URL.', 'error', 'emissionStatusMessage');
            if (!prompts) return showStatus('Please enter emission prompts.', 'error', 'emissionStatusMessage');
            
            showStatus('Updating...', 'info', 'emissionStatusMessage');
            const startTime = Date.now();
            
            try {
                const response = await fetch(webhookUrl, { 
                    method: 'POST', 
                    body: JSON.stringify({ prompts }), 
                    headers: {'Content-Type': 'application/json'} 
                });
                const responseData = await response.json();
                displayApiResponse(responseData, 'emission', startTime);
                showStatus('Updated successfully!', 'success', 'emissionStatusMessage');
            } catch(e) {
                displayApiResponse({success: false, error: e.message}, 'emission', startTime);
                showStatus('Update failed!', 'error', 'emissionStatusMessage');
            }
        }

        // Sustainability Reporting Functions
        (function initReporting() {
            const btnGenerate = document.getElementById('btnGenerateReport');
            const btnDownload = document.getElementById('btnDownloadReport');
            const inputUrl = document.getElementById('n8nWebhookUrl');
            const statusEl = document.getElementById('reportStatus');
            const iframe = document.getElementById('reportIframe');
            const empty = document.getElementById('reportEmptyState');

            let latestBlobUrl = null;
            let latestFilename = 'ESG_Report.html';

            function setBusy(busy) {
                if (busy) {
                    btnGenerate.setAttribute('disabled', 'true');
                    btnGenerate.classList.add('loading');
                    statusEl.textContent = 'Generating report...';
                } else {
                    btnGenerate.removeAttribute('disabled');
                    btnGenerate.classList.remove('loading');
                }
            }

            async function generateReport() {
                const url = (inputUrl && inputUrl.value) ? inputUrl.value.trim() : '/webhook/report';
                if (!url) {
                    showToast('Please provide a valid Webhook URL', 'warning');
                    return;
                }
                
                setBusy(true);
                btnDownload.setAttribute('disabled', 'true');
                
                try {
                    const res = await fetch(url, { method: 'GET' });
                    if (!res.ok) {
                        throw new Error('HTTP ' + res.status + ' - ' + (await res.text()).slice(0, 200));
                    }
                    
                    const contentType = res.headers.get('Content-Type') || 'text/html; charset=utf-8';
                    let filename = 'ESG_Report.html';
                    const dispo = res.headers.get('Content-Disposition');
                    if (dispo) {
                        const m = /filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(dispo);
                        if (m) { 
                            filename = decodeURIComponent(m[1] || m[2]); 
                        }
                    }
                    latestFilename = filename;

                    const text = await res.text();
                    
                    // Render in viewer
                    iframe.srcdoc = text;
                    iframe.style.display = 'block';
                    empty.style.display = 'none';

                    // Prepare download
                    if (latestBlobUrl) URL.revokeObjectURL(latestBlobUrl);
                    const blob = new Blob([text], { type: contentType });
                    latestBlobUrl = URL.createObjectURL(blob);
                    btnDownload.removeAttribute('disabled');

                    statusEl.textContent = 'Report generated successfully.';
                    showToast('Report ready');
                    
                } catch (err) {
                    console.error(err);
                    statusEl.textContent = 'Failed to generate report.';
                    showToast('Failed to generate report: ' + err.message, 'error');
                } finally {
                    setBusy(false);
                }
            }

            function downloadReport() {
                if (!latestBlobUrl) return;
                const a = document.createElement('a');
                a.href = latestBlobUrl;
                a.download = latestFilename;
                document.body.appendChild(a);
                a.click();
                a.remove();
            }

            if (btnGenerate) { 
                btnGenerate.addEventListener('click', generateReport); 
            }
            if (btnDownload) { 
                btnDownload.addEventListener('click', downloadReport); 
            }
        })();

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default active navigation
            document.querySelector('.nav-link').classList.add('active');
            
            // Auto-generate agent path when name changes
            updateAgentPath();
            
            showToast('SustainIQ Dashboard loaded successfully');
        });
    </script>
</body>
</html>